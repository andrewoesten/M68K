;==========================================================
; ASM Testcase
; flype, 2015-09-26
; luhn_checksum()
;==========================================================
; http://www.simplycalc.com/luhn-source.php
;==========================================================

;==========================================================
; Constants
;==========================================================

ASSERT_ZERO EQU $00D0000C

;==========================================================
; MAIN()
; A0 = VALUES
; A1 = PRECALC
; D0 = Result
; D1 = Value Bytes Length
; D7 = Total Result
;==========================================================

;	DC.L	0
;	DC.L	START
;	SECTION .FASTRAM

START:
	LEA		VALUES,A0		; Values
	LEA		PRECALC,A1		; Checksums
	CLR.L	D7				; Total Result
LOOP:
	CLR.L	D0				; Result
	CLR.L	D1				; Value Bytes Length
	MOVE.B	(A0),D1			; Read length
	JSR		LUHN			; Luhn(Value)
	ADD.L	D0,D7			; Total Result
	SUB.B	(A1)+,D0		; Result - Precalc
	MOVE.L	D0,ASSERT_ZERO	; Assert D0 == 0
	MOVE.B	(A0),D1			; Read length
	ADD.L	D1,A0			; Next Value
	ADD.L	#1,A0			; 
	CMP.B	#0,(A0)			; Check if last value
	BNE		LOOP			; Continue while != 0
EXIT:
	SUB.W	(A1),D7			; Total Result - Total Precalc
	MOVE.L	D7,ASSERT_ZERO	; Assert D7 == 0
	TST		$0				; FLUSH
	;STOP	#-1				; STOP SIM
	RTS

;==========================================================
; LUHN()
; Input  : A0 = Value
; Input  : D1 = Value Bytes Length
; Output : D0 = Checksum
;==========================================================

LUHN:
	CLR.L	D0				; Checksum
	CLR.L	D3				; Digit
	MOVE.L	D1,D2			; Parity = Length
	ANDI.L	#1,D2			; Parity % 2
	SUBI.L	#1,D1			; Length - 1
LUHNLOOP:
	MOVE.B	1(A0,D1),D3		; Digit = code.charAt(i)
	SUBI.B 	#$30,D3			; Digit = parseInt(Digit)
	MOVE.L	D1,D4			; i
	ANDI.L	#1,D4			; i % 2
	CMP.L	D4,D2			; Compare D4 and D2
	BNE		LUHNNEXT1		; If (i % 2 == Parity)
	LSL.L	#1,D3			; Digit * 2
LUHNNEXT1:
	CMPI.L	#9,D3			; Compare 9 and D3
	BLE		LUHNNEXT2		; If (Digit > 9)
	SUBI.L	#9,D3			; Digit - 9
LUHNNEXT2:
	ADD.L	D3,D0			; Checksum + Digit
	DBF		D1,LUHNLOOP		; Continue
LUHNEXIT:
	DIVU.W	#10,D0			; Checksum / 10
	SWAP	D0				; 
	MOVE.W	D0,D1			; Checksum % 10
	MOVE.L	#10,D0			; 
	SUB.L	D1,D0			; 10 - Checksum
	RTS						; return Checksum

;==========================================================
; Data Section
;==========================================================

VALUES:
 DC.B 47,'48729691684486443854200009417894066566631268770'
 DC.B 60,'531903967948634316637540223401956811490684678424113711333650'
 DC.B 40,'6108365904380588311884177235546592497400'
 DC.B 24,'626054597553296925522900'
 DC.B 58,'9877544327711112763172188149745894948497052869429977441090'
 DC.B 55,'9797888429943630147205227870592327684159502452706657230'
 DC.B 48,'473693342930436309721549743264328080579299668230'
 DC.B 30,'874161882693190358600151622350'
 DC.B 40,'3190234541208463612142147137408753961110'
 DC.B 48,'602869749649316403368226985143175235152936502530'
 DC.B 56,'67359001242025820619525249842280244681196939601024075820'
 DC.B 22,'1312026506098380022220'
 DC.B 20,'11883690519375510480'
 DC.B 54,'516566939035761627389935849833737476378769607717484430'
 DC.B 26,'11681684150539082662827220'
 DC.B 24,'221330134483168771652160'
 DC.B 17,'83604559139064800'
 DC.B 50,'12496687396707139356208472475610369016296261571960'
 DC.B 59,'90680700026948769374758827935358313471149486880657991673590'
 DC.B 28,'1388748693567120810440390810'
 DC.B 58,'6784954886786249898867710298229572410675309444553060484710'
 DC.B 26,'73746385111354697586392240'
 DC.B 44,'95402578494855986360181726485955972822476880'
 DC.B 31,'4166561262566733457643916710510'
 DC.B 30,'992846129271401041114733118870'
 DC.B 23,'58927787623920901258120'
 DC.B 58,'2564928307604367737945526677328424989009915180839664616990'
 DC.B 55,'5126147538828796364601112053430572582122842521997090290'
 DC.B 60,'734324236217710251340059163781852726188144029015543514468400'
 DC.B 50,'82695510699860324482702917460954441626578585168370'
 DC.B 60,'463334044515396535371516326378283067161074593820587277047980'
 DC.B 40,'0751603236297350525889636920259978305740'
 DC.B 30,'807278327391631074265704517700'
 DC.B 35,'57700193708140480908565973325542860'
 DC.B 42,'832451793707321832220074163119946647562400'
 DC.B 18,'014174837236120320'
 DC.B 27,'454057515632644012002067570'
 DC.B 56,'13136265304542090315895660971041658044917774415111531750'
 DC.B 57,'041205234360834641443452259008419909079495922532011093320'
 DC.B 61,'7431760242955102150715685127141190635028745280778877062414710'
 DC.B 50,'56954656662135662629621675598007985962914369702960'
 DC.B 60,'869100180003307891861150840249072328524419754139560135701500'
 DC.B 44,'64885795631547659217670133711828500878725840'
 DC.B 37,'6586251497044556031166724939566917910'
 DC.B 30,'013219573485183063908371236880'
 DC.B 45,'552725727739680850212558583923724942598025470'
 DC.B 53,'32688006396932812106800957280438272777312086694823230'
 DC.B 59,'19332529960272121649207969758381887490189292428804561087570'
 DC.B 40,'5265354237353066954308720120560302112050'
 DC.B 61,'1243488599742612276968541024282597398926617197350612633377420'
 DC.B 32,'12633072700688405477104526377810'
 DC.B 20,'24816958335076713240'
 DC.B 23,'16691598824593753195190'
 DC.B 58,'6570900130787826799659679896693223600515582896725718647480'
 DC.B 53,'41535799201852756446886772301729203047056639077024490'
 DC.B 57,'929979339375006722112790258477372366382969368449506166660'
 DC.B 30,'739942584790947711604253358000'
 DC.B 27,'391661290246586673608759900'
 DC.B 31,'9940521032184186149539740558860'
 DC.B 23,'59679508962379016850280'
 DC.B 42,'093843253804027746682424830101338041423040'
 DC.B 47,'07851136010020578147320100386838922114209741190'
 DC.B 53,'88817358423806568069286973762298118099066122635479310'
 DC.B 23,'58731301568336067629260'
 DC.B 39,'809516310956722968299465496402387102080'
 DC.B 54,'908277554133233195537823344468198323674905209024947460'
 DC.B 57,'674042673755718293872465502081566133183272515652690408610'
 DC.B 52,'3501272159318883573998019436964572841971117078436410'
 DC.B 60,'505532863678480839277749030214667341096005577448550817095210'
 DC.B 40,'8158584565020192332565575357145420650410'
 DC.B 40,'6636610842771184488678861721341732230000'
 DC.B 43,'4893130738537953204226869143972384756451510'
 DC.B 46,'9267825664928464870994255031502385151596822320'
 DC.B 20,'66825201887176648220'
 DC.B 16,'7719616158376690'
 DC.B 42,'593110155603925171641840241949688486351640'
 DC.B 48,'629052990234421656358167179574299414910602295410'
 DC.B 47,'30838922817526496289753415177784099208956161950'
 DC.B 31,'6950008742032041284401142791080'
 DC.B 31,'6055337891263673963273652072980'
 DC.B 46,'0669927247823194429050195326637972879763788320'
 DC.B 39,'001511945429752870445458876746521192970'
 DC.B 32,'82454936742842546070565335669520'
 DC.B 42,'172724875740766145375800668842505907403380'
 DC.B 23,'78464409998628253383460'
 DC.B 57,'594848931474053261832107793217411639391410297989511511970'
 DC.B 26,'04302092512228207073675960'
 DC.B 36,'146704890186840196026815341980398980'
 DC.B 40,'1342868986414336531455461269763117903970'
 DC.B 28,'4967442327907576323125367740'
 DC.B 25,'1144523096806780103228230'
 DC.B 25,'7717367624854147762605000'
 DC.B 43,'2019495667182690859177067762033902917657610'
 DC.B 21,'173119937788774202310'
 DC.B 49,'9355572844242741928148347453121806432244455117140'
 DC.B 43,'5214989351348123336703537977351859456087250'
 DC.B 40,'5660399929137655059369411037490865692760'
 DC.B 49,'8013139868084772429649931156866094357489106534360'
 DC.B 27,'941210683137270533997596220'
 DC.B 41,'28718480286431042121583783987671171238320'
 DC.B 0
 DC.B 0

PRECALC:
 DC.B 05,09,03,03,08,06,08,04,04,03
 DC.B 04,07,04,04,07,02,03,01,06,04
 DC.B 04,08,03,09,06,05,05,01,05,10
 DC.B 06,04,04,01,07,01,03,10,01,02
 DC.B 08,01,06,01,08,07,08,07,04,09
 DC.B 03,10,08,08,09,07,08,08,06,03
 DC.B 03,04,07,09,05,05,06,10,04,04
 DC.B 08,03,05,06,09,02,07,07,08,02
 DC.B 05,03,06,06,07,03,05,07,09,07
 DC.B 09,06,06,08,03,07,10,08,10,07
 DC.W 565

;==========================================================
; End of file
;==========================================================

;==========================================================
; ASM Testcase
; flype, 2015-09-26
; luhn_checksum()
;==========================================================
; http://www.simplycalc.com/luhn-source.php
;==========================================================

;==========================================================
; Constants
;==========================================================

ASSERT_ZERO EQU $00D0000C

;==========================================================
; MAIN()
; A0 = VALUES
; A1 = PRECALC
; D0 = Result
; D1 = Value Bytes Length
; D7 = Total Result
;==========================================================

;	DC.L	0
;	DC.L	START
;	SECTION .FASTRAM

START:
	LEA		VALUES,A0		; Values
	LEA		PRECALC,A1		; Checksums
	CLR.L	D7				; Total Result
LOOP:
	CLR.L	D0				; Result
	CLR.L	D1				; Value Bytes Length
	MOVE.B	(A0),D1			; Read length
	JSR		LUHN			; Luhn(Value)
	ADD.L	D0,D7			; Total Result
	SUB.B	(A1)+,D0		; Result - Precalc
	MOVE.L	D0,ASSERT_ZERO	; Assert D0 == 0
	MOVE.B	(A0),D1			; Read length
	ADD.L	D1,A0			; Next Value
	ADD.L	#1,A0			; 
	CMP.B	#0,(A0)			; Check if last value
	BNE		LOOP			; Continue while != 0
EXIT:
	SUB.W	(A1),D7			; Total Result - Total Precalc
	MOVE.L	D0,ASSERT_ZERO	; Assert D0 == 0
	TST		$0				; FLUSH
	;STOP	#-1				; STOP SIM
	RTS

;==========================================================
; LUHN()
; Input  : A0 = Value
; Input  : D1 = Value Bytes Length
; Output : D0 = Checksum
;==========================================================

LUHN:
	CLR.L	D0				; Checksum
	CLR.L	D3				; Digit
	MOVE.L	D1,D2			; Parity = Length
	ANDI.L	#1,D2			; Parity % 2
	SUBI.L	#1,D1			; Length - 1
LUHNLOOP:
	MOVE.B	1(A0,D1),D3		; Digit = code.charAt(i)
	SUBI.B 	#$30,D3			; Digit = parseInt(Digit)
	MOVE.L	D1,D4			; i
	ANDI.L	#1,D4			; i % 2
	CMP.L	D4,D2			; Compare D4 and D2
	BNE		LUHNNEXT1		; If (i % 2 == Parity)
	LSL.L	#1,D3			; Digit * 2
LUHNNEXT1:
	CMPI.L	#9,D3			; Compare 9 and D3
	BLE		LUHNNEXT2		; If (Digit > 9)
	SUBI.L	#9,D3			; Digit - 9
LUHNNEXT2:
	ADD.L	D3,D0			; Checksum + Digit
	DBF		D1,LUHNLOOP		; Continue
LUHNEXIT:
	DIVU.W	#10,D0			; Checksum / 10
	SWAP	D0				; 
	MOVE.W	D0,D1			; Checksum % 10
	MOVE.L	#10,D0			; 
	SUB.L	D1,D0			; 10 - Checksum
	RTS						; return Checksum

;==========================================================
; Data Section
;==========================================================

VALUES:
 DC.B 20,'76983976504094391680'
 DC.B 59,'37957863190993015756860502894063114353658762508096310021290'
 DC.B 59,'48555145514216579222511792723842142136896081921145823707220'
 DC.B 25,'6789350921144158359260410'
 DC.B 21,'580867257392793446450'
 DC.B 24,'371916737582862283788950'
 DC.B 25,'5160943613733345757948740'
 DC.B 58,'1705184053337923964517812361817499488654827766762569960360'
 DC.B 30,'871336310412169699992703968580'
 DC.B 56,'20468618565357504805865782715439314252891202648919250090'
 DC.B 46,'6640475121103017635711112626385208912960495900'
 DC.B 29,'89238891129602273708923340920'
 DC.B 18,'352221826066945830'
 DC.B 32,'35133198589757138799251219924610'
 DC.B 32,'19378334088063050950609777018810'
 DC.B 25,'2364509597799135249737490'
 DC.B 61,'0586980576902885441271795557826441521544420467850730966331350'
 DC.B 52,'4038851062558284738453084356307713001326962613581210'
 DC.B 48,'468201045639018548478346783401871214984337150390'
 DC.B 30,'016669501841542230907143816670'
 DC.B 37,'0412527871858381077989525653193548400'
 DC.B 20,'16569180305628306250'
 DC.B 18,'788362981943953970'
 DC.B 20,'65207936659205072400'
 DC.B 39,'798902957229482249306019705799759049520'
 DC.B 17,'97241751015427370'
 DC.B 27,'785681580692029577592110730'
 DC.B 60,'490817744727469035306091076437131599155226999062629345192920'
 DC.B 24,'024933419079033160633300'
 DC.B 61,'9535262001922184972495222767570305609401579080275716943035880'
 DC.B 53,'16778224225205459435852367429314815301708899459356790'
 DC.B 25,'4931572198684760792606590'
 DC.B 44,'98166893090595259259713196993440871603600260'
 DC.B 42,'482151095456870798935384354953287536603300'
 DC.B 30,'381881619545267378574976078430'
 DC.B 53,'57218820322726879644620140474814126534973529776921910'
 DC.B 34,'2681505262741230127087456081882250'
 DC.B 40,'7072349769505916882477943061415219656480'
 DC.B 45,'311728868411918405558710100423182881928092640'
 DC.B 21,'702350816516237913770'
 DC.B 24,'349339706148993381830200'
 DC.B 25,'5516788341573095427236630'
 DC.B 50,'73296977997072974117050410603411438747040085965640'
 DC.B 54,'662821506848147632714533820023074368305637337002918610'
 DC.B 59,'90380209399623280976679715774281662794443974675383771645070'
 DC.B 46,'0271801404169272329989907428012915646048886150'
 DC.B 31,'5405996132249851130594423428940'
 DC.B 61,'5397171238180753504863855967282265224991770023761660889011170'
 DC.B 18,'773822422592974320'
 DC.B 47,'29119466272924794423884041311662922726346693380'
 DC.B 39,'303293837492193766861535388301009994220'
 DC.B 25,'8452446239319106587638430'
 DC.B 34,'9857569257807538453762944877955660'
 DC.B 28,'7621127766541930974740527960'
 DC.B 55,'3992226918111488530378960534732362511617093326363721260'
 DC.B 43,'6827534593259779108112901225089700639722110'
 DC.B 32,'92008045253127964394627534977060'
 DC.B 39,'630846225771702521432861506407311230350'
 DC.B 30,'465831267593896243596425488100'
 DC.B 35,'06150086688871995834315251031974270'
 DC.B 53,'09423166250321302928102548947716929349407764292890890'
 DC.B 53,'64762317352908590451721869425136127282687678639557830'
 DC.B 61,'1855946487613305843743066921357842335535758575239164370466800'
 DC.B 16,'2730126469808580'
 DC.B 52,'1031900404487302742690415370487653662557564623193550'
 DC.B 52,'0773672952633366498597423194689975287062601014228900'
 DC.B 61,'0724973104375842765242967578784293803861849582739876121705490'
 DC.B 52,'2691810589686555030326865220977974902633412073943810'
 DC.B 37,'7707100913660706080663536909234954190'
 DC.B 32,'85197050442693619854242936921350'
 DC.B 60,'657796102515374742253848646008699984624399592099215404097820'
 DC.B 34,'8270774663472530095249675438938050'
 DC.B 38,'33930393507203985285817575146047223860'
 DC.B 17,'98446444410759530'
 DC.B 24,'971280834121585746180840'
 DC.B 49,'4977501094439042613180734492966709336557671099020'
 DC.B 21,'524914590835227741590'
 DC.B 49,'5369321371839392897934159505134306285119294457740'
 DC.B 56,'13670195685875232736573750276786047687718917636660385810'
 DC.B 27,'590111408562274295581187250'
 DC.B 33,'526943208664926788384715967038970'
 DC.B 33,'171247617144135030446795395919660'
 DC.B 26,'64943347928441581985399720'
 DC.B 41,'09309948882734102617022584808511482612190'
 DC.B 32,'40316109852579376764075265554020'
 DC.B 51,'143410199340459432363185453866536146131936740655110'
 DC.B 20,'37365985920472343590'
 DC.B 22,'8684155606349720401720'
 DC.B 19,'1513987467469766550'
 DC.B 32,'34587992360299110655223244254330'
 DC.B 52,'7625086271641346189944521028280115444267770667086420'
 DC.B 44,'79486842698143642216021205557639850045856760'
 DC.B 40,'6569116555268733338752089176347465770480'
 DC.B 56,'15348881974394967470805955342609191216872563682758062380'
 DC.B 31,'9846519458016635494820680491150'
 DC.B 51,'179719956077622307933830177789831171822310090793820'
 DC.B 16,'5577508067254510'
 DC.B 26,'66453129224017293595943050'
 DC.B 35,'31279846038527529975247533901125980'
 DC.B 17,'81720358090193330'
 DC.B 23,'41870319982019316181500'
 DC.B 48,'003946945206886022806391664601568638085430147560'
 DC.B 50,'99521822957265405932165272145513795098266787235150'
 DC.B 21,'314445741821087690780'
 DC.B 22,'1952521899030724859760'
 DC.B 35,'98026603201980877298917602466907080'
 DC.B 59,'98116459215106679420227866600805136970043229009720841945120'
 DC.B 49,'1685718658143828382459207331458056807525654386350'
 DC.B 44,'15184626893359003233307890067233048972040690'
 DC.B 22,'8512403410869287144120'
 DC.B 57,'885983269391707719333193283708835247577898056980504664010'
 DC.B 55,'3256170722043849126531228561453986926633010503769777220'
 DC.B 48,'711132456079958856879031085623881223693101011750'
 DC.B 33,'382993965720287420948501190581490'
 DC.B 45,'432394998616521253485712197845226736947597180'
 DC.B 43,'5899825211405323572075389693373911045236280'
 DC.B 23,'79999382707634424546670'
 DC.B 37,'9179307322757237992071174280548202630'
 DC.B 20,'39003882110313507390'
 DC.B 23,'68559018771515160586230'
 DC.B 17,'01896862200078790'
 DC.B 53,'99532154148425550435035051968942660061679957420768590'
 DC.B 17,'85973616702751790'
 DC.B 60,'583659490852220218539007711721821563822047820863500259930170'
 DC.B 25,'8735205836579602145339440'
 DC.B 18,'983918582594793930'
 DC.B 54,'019718216402296921679895744245866196203421989382980150'
 DC.B 55,'6186185464025930260932344617587769246975181172327018570'
 DC.B 53,'17311012379099106136565017941191971320678481799009330'
 DC.B 57,'072819338528557967642635835974064283593087553982527106150'
 DC.B 55,'3716489003249784600598256182024153840382375778122472750'
 DC.B 33,'707267809364894652893183518221810'
 DC.B 27,'451068737217881773297775420'
 DC.B 27,'450014835302710998472056880'
 DC.B 41,'75960910565363525383179406238498408233870'
 DC.B 46,'7507731672133864003277832816319604262296329670'
 DC.B 25,'6560090014315296193599180'
 DC.B 61,'6825255605178757777884168721946017002409930454849989565836120'
 DC.B 60,'829867526734770784037262606434147982967527643573373495016330'
 DC.B 43,'1588587216623475521068023783331682995499770'
 DC.B 16,'6586194345581020'
 DC.B 55,'5073063001845502641549712631227936093856477412627707900'
 DC.B 25,'4930535875034475751052100'
 DC.B 39,'200966265198308993668806308519211996610'
 DC.B 55,'6127947035920343169818681518407808832374882961130596980'
 DC.B 27,'601759182787981894704168550'
 DC.B 37,'1759238134922312746634366116139985790'
 DC.B 21,'697244957384842702610'
 DC.B 60,'494242426378694967215710225200728134324623971955747421655170'
 DC.B 18,'436675002661910700'
 DC.B 56,'81666953312800608004504260724804556572697329405341904940'
 DC.B 46,'5329314186646495694404797660585326682857593010'
 DC.B 49,'0809120400616774662263906552527760538121106019530'
 DC.B 29,'16340796607216541501402709830'
 DC.B 26,'00683370410904672866093320'
 DC.B 46,'6729470618545204800094993512471874372621067550'
 DC.B 56,'34582220180858064329783560676709499888551213434158051380'
 DC.B 60,'233642954856190568737726144522135860119524872079777289724040'
 DC.B 58,'3771650771681116557492998433752401634713833395393621132500'
 DC.B 51,'856746219367934746415400062818466520220993724728220'
 DC.B 38,'02779971706027703670159305321815573310'
 DC.B 35,'27033729930457896992756943141322670'
 DC.B 43,'2615953004306347941651797328017538867723280'
 DC.B 27,'979701302602068062169484120'
 DC.B 58,'2371783720604923055699695638465973595137203026708827337220'
 DC.B 16,'2671028393834890'
 DC.B 36,'568483462940099642012502542019236340'
 DC.B 55,'8422582553454503188514986492018739627913070220853810020'
 DC.B 31,'9722134792688433350054476833040'
 DC.B 33,'299459124409132831801629271891600'
 DC.B 25,'3072309189511712289333900'
 DC.B 42,'599867751056747053844066254322706624479230'
 DC.B 45,'796652984877621794425522200876584026189144680'
 DC.B 34,'6045563142023465936093766232766830'
 DC.B 30,'124111631928525229762845571370'
 DC.B 27,'577241966879744923836264880'
 DC.B 54,'203300575062024219547752116139568589516035820536655710'
 DC.B 59,'70396061680629461458510776522555403744746544517840120325240'
 DC.B 58,'1555712963689486257466702015114146353711826411757259680910'
 DC.B 24,'703412388161127652146480'
 DC.B 42,'346143023767082360005022207672350511739060'
 DC.B 55,'4520979734861673109967782566158358497422239719865245890'
 DC.B 48,'246204393366310629147696537617840758882496482360'
 DC.B 46,'2515163487839710046948689100230711651727535760'
 DC.B 42,'034874102933075843872484206309595235089640'
 DC.B 48,'690898057572494071189059193558454615807223378560'
 DC.B 23,'25334288158073100692170'
 DC.B 58,'0118123982382896413155309264480618788133634455191442442070'
 DC.B 36,'106269821366902223239875050636287280'
 DC.B 50,'67245420528306351936475151910758819131678553074060'
 DC.B 35,'58717754614188358513827495055757870'
 DC.B 47,'76085723156832585061577397057848173694084721530'
 DC.B 60,'515811608555775321763607838178463912191093511899191501724470'
 DC.B 18,'786996854712580480'
 DC.B 16,'6767607852507230'
 DC.B 54,'134772754328416974089640876848137268264022840164761140'
 DC.B 47,'21526021929714466018847863121906292129758498820'
 DC.B 47,'79751936313565637419884271957295338348702951340'
 DC.B 41,'15549282711721028309392825740816500684060'
 DC.B 47,'92133769792880306799032078181638982591148220750'
 DC.B 0
 DC.B 0

PRECALC:
 DC.B 4,4,4,9,2,2,10,6,7,8,6,7,9,9,1,3,4,1,4,3,7,1,9,3,8,3,2,1,2,7,3
 DC.B 6,7,3,6,4,5,8,10,6,1,6,8,1,7,10,10,3,7,2,2,10,2,8,10,7,4,7,6,7,8,5
 DC.B 2,4,4,6,4,3,8,1,5,6,6,10,2,4,6,8,1,2,6,8,8,10,1,1,1,5,3,7,9,4,5
 DC.B 6,6,8,10,7,10,6,9,6,7,1,6,6,9,1,1,7,10,7,8,2,2,1,10,2,3,4,6,7,10,9
 DC.B 3,2,8,4,10,2,5,2,8,9,1,9,3,4,5,2,9,10,8,4,5,3,2,8,6,9,4,8,5,6,10
 DC.B 2,8,10,10,2,3,4,2,5,9,5,10,2,7,6,5,8,10,1,2,3,3,5,1,7,4,4,7,1,4,7
 DC.W 1088

;==========================================================
; End of file
;==========================================================
